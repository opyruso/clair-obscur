<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clair Obscur - Picto Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #191c23;
      color: #eee;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1050px;
      margin: 40px auto;
      padding: 24px;
    }
    h1 {
      color: #e0e0ff;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .actions {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .searchbar {
      width: 100%;
      padding: 12px;
      background: #262b36;
      border: 1px solid #333;
      color: #fff;
      border-radius: 8px;
      font-size: 1.1em;
      box-sizing: border-box;
      margin-bottom: 0;
    }
    .toggle-btn {
      background: #23263a;
      color: #b6e4ff;
      border: 1px solid #3d4769;
      padding: 8px 18px;
      border-radius: 9px;
      font-size: 1.08em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.16s, color 0.18s;
      margin-left: 0;
    }
    .toggle-btn.active, .toggle-btn:hover {
      background: #2c3142;
      color: #fff;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 18px;
    }
    .card {
      background: #23263a;
      border-radius: 14px;
      box-shadow: 0 2px 8px #0006;
      padding: 22px 20px 18px 20px;
      display: flex;
      flex-direction: column;
      min-height: 210px;
      transition: box-shadow .2s, background 0.18s;
      border: 1px solid #2c3142;
    }
    .card.owned {
      background: linear-gradient(120deg, #254B2F 60%, #23263a 100%);
      border-color: #3da878;
      box-shadow: 0 4px 20px #214b2f88;
    }
    .card:hover {
      box-shadow: 0 6px 16px #000a;
    }
    .region {
      color: #7cc9ff;
      font-size: 0.93em;
      font-weight: 600;
      letter-spacing: 1px;
      margin-bottom: 5px;
    }
    .name {
      font-size: 1.28em;
      font-weight: 700;
      color: #fff;
      margin-bottom: 2px;
    }
    .badges {
      margin: 7px 0 8px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .badge {
      display: inline-block;
      background: #333b6b;
      color: #f5fbff;
      font-size: 0.96em;
      padding: 4px 12px 3px 12px;
      border-radius: 10px;
      font-weight: 600;
      letter-spacing: .5px;
      border: 1px solid #4276a8;
    }
    .section-title {
      font-size: 0.97em;
      color: #b6e4ff;
      font-weight: 500;
      margin-top: 2px;
      margin-bottom: 0;
    }
    .bonus-lumina, .description {
      font-size: 0.98em;
      margin: 4px 0 2px 0;
      color: #d4e4ef;
      white-space: pre-line;
    }
    .description {
      color: #c9bfff;
      margin-top: 7px;
    }
    /* Tableau sombre + owned */
    table {
      border-collapse: collapse;
      width: 100%;
      background: #21232d;
      color: #fff;
      margin-top: 8px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 8px #0005;
    }
    th, td {
      padding: 10px 10px;
      border-bottom: 1px solid #2c3142;
      text-align: left;
    }
    th {
      background: #25273a;
      color: #b6e4ff;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
      font-size: 1.07em;
    }
    th.sorted-asc:after { content: " ‚¨ÜÔ∏è"; font-size: 0.85em; }
    th.sorted-desc:after { content: " ‚¨áÔ∏è"; font-size: 0.85em; }
    tr.owned td, tr.owned th {
      background: linear-gradient(90deg, #214b2f 70%, #23263a 100%) !important;
    }
    .checkbox-cell {
      text-align: center;
      padding-left: 0;
      padding-right: 0;
      width: 44px;
    }
    .nowrap {
      white-space: nowrap;
    }
    ::selection {
      background: #387ad0;
      color: #fff;
    }
    @media (max-width: 700px) {
      .container { padding: 5px; }
      .cards { grid-template-columns: 1fr; }
      th, td { font-size: 0.93em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Clair Obscur - Pictos</h1>
    <div class="actions">
      <button class="toggle-btn active" id="toggleViewBtn">üóÇÔ∏è Switch to Table</button>
      <input class="searchbar" id="search" placeholder="Search pictos by any field...">
    </div>
    <div id="cards" style="display:block"></div>
    <div id="table" class="table-view" style="display:none"></div>
  </div>
  <script>
    const jsonUrl = "data/picto-dictionnary.json";
    const myPictosUrl = "data/myPictos.json";
    let pictos = [];
    let pictosFiltered = [];
    let myPictosSet = new Set();
    let currentView = "cards";
    let sortCol = null, sortDir = 1; // 1 asc, -1 desc

    // Traduction pour badges
    const pictoLabels = {
      "defence": "Defence",
      "speed": "Speed",
      "critical-luck": "Crit. Luck",
      "health": "Health"
    };

    const tableCols = [
      {key: "checkbox", label: ""},
      {key: "name", label: "Name"},
      {key: "region", label: "Region"},
      {key: "level", label: "Level"},
      {key: "defence", label: "Defence"},
      {key: "speed", label: "Speed"},
      {key: "critical-luck", label: "Crit. Luck"},
      {key: "health", label: "Health"},
      {key: "bonus_lumina", label: "Lumina Bonus"},
      {key: "unlock_description", label: "Unlock"}
    ];

    // On charge les deux fichiers JSON puis on lance le rendu
    Promise.all([
      fetch(jsonUrl).then(r => r.json()),
      fetch(myPictosUrl).then(r => r.json())
    ]).then(([data, myData]) => {
      pictos = data;
      pictosFiltered = pictos.slice();
      myPictosSet = new Set((myData || []).filter(x => x.ref).map(x => x.ref));
      render();
    });

    // Recherche/filter
    document.getElementById("search").addEventListener("input", e => {
      const term = e.target.value.trim().toLowerCase();
      pictosFiltered = pictos.filter(p => {
        return Object.values(p).some(v => (v && typeof v === 'string' && v.toLowerCase().includes(term)))
          || (p.bonus_picto && Object.entries(p.bonus_picto).some(([k,v]) => String(v).toLowerCase().includes(term)));
      });
      render();
    });

    // Toggle Vue
    document.getElementById("toggleViewBtn").addEventListener("click", () => {
      currentView = currentView === "cards" ? "table" : "cards";
      document.getElementById("toggleViewBtn").textContent =
        currentView === "cards" ? "üóÇÔ∏è Switch to Table" : "üÉè Switch to Cards";
      render();
    });

    function render() {
      document.getElementById("cards").style.display = currentView === "cards" ? "block" : "none";
      document.getElementById("table").style.display = currentView === "table" ? "block" : "none";
      if(currentView === "cards") renderCards();
      else renderTable();
    }

    // Vue Cartes
    function renderCards() {
      const container = document.getElementById("cards");
      container.innerHTML = "";
      pictosFiltered.forEach(p => {
        const owned = myPictosSet.has(p.id);
        const card = document.createElement("div");
        card.className = "card" + (owned ? " owned" : "");
        if (p.region)
          card.innerHTML += `<div class="region">${p.region}</div>`;
        card.innerHTML += `<div class="name">${p.name}</div>`;
        if (p.level)
          card.innerHTML += `<div class="section-title">Level</div><div class="badges"><span class="badge">Lv. ${p.level}</span></div>`;
        if (p.bonus_picto && Object.keys(p.bonus_picto).length > 0) {
          card.innerHTML += `<div class="section-title">Picto Bonus</div>`;
          let badges = '';
          for (const k in p.bonus_picto) {
            badges += `<span class="badge">${pictoLabels[k] || k}: ${p.bonus_picto[k]}${k==="critical-luck"?"%":""}</span>`;
          }
          card.innerHTML += `<div class="badges">${badges}</div>`;
        }
        if (p.bonus_lumina)
          card.innerHTML += `<div class="section-title">Lumina Bonus</div><div class="bonus-lumina">${p.bonus_lumina}</div>`;
        if (p.unlock_description)
          card.innerHTML += `<div class="section-title">Unlock</div><div class="description">${p.unlock_description}</div>`;
        container.appendChild(card);
      });
    }

    // Vue Tableau
    function renderTable() {
      const div = document.getElementById("table");
      let html = `<table><thead><tr>`;
      tableCols.forEach((col, i) => {
        if(col.key==="checkbox")
          html += `<th></th>`;
        else
          html += `<th onclick="window.sortTableCol(${i})" class="${sortCol===i ? (sortDir==1?'sorted-asc':'sorted-desc') : ''}">${col.label}</th>`;
      });
      html += `</tr></thead><tbody>`;
      pictosFiltered.forEach(p => {
        const owned = myPictosSet.has(p.id);
        html += `<tr${owned ? ' class="owned"' : ''}>`;
        // Checkbox en premi√®re colonne
        html += `<td class="checkbox-cell"><input type="checkbox"${owned ? " checked" : ""} disabled></td>`;
        tableCols.slice(1).forEach(col => {
          let val = "";
          if (["defence","speed","critical-luck","health"].includes(col.key)) {
            val = (p.bonus_picto && typeof p.bonus_picto[col.key] !== "undefined") ? p.bonus_picto[col.key] : "";
            if(col.key==="critical-luck" && val!=="") val = val+"%";
          } else if (col.key === "level") {
            val = p.level || "";
          } else {
            val = p[col.key] || "";
          }
          html += `<td class="${["defence","speed","critical-luck","health"].includes(col.key) ? 'nowrap' : ''}">${val}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      div.innerHTML = html;
    }

    // Tri tableau (accessible depuis onClick HTML, pour compatibilit√© file://)
    window.sortTableCol = function(idx) {
      // Pour les colonnes bonus_picto, tri descendant par d√©faut (sortDir = -1)
      if(["defence","speed","critical-luck","health"].includes(tableCols[idx].key)) {
        if(sortCol === idx) sortDir = -sortDir;
        else { sortCol = idx; sortDir = -1; }
      } else {
        if(sortCol === idx) sortDir = -sortDir;
        else { sortCol = idx; sortDir = 1; }
      }
      const key = tableCols[idx].key;
      pictosFiltered.sort((a,b) => {
        let av, bv;
        if (["defence","speed","critical-luck","health"].includes(key)) {
          av = a.bonus_picto?.[key] ?? -Infinity;
          bv = b.bonus_picto?.[key] ?? -Infinity;
          av = isNaN(av) ? -Infinity : av;
          bv = isNaN(bv) ? -Infinity : bv;
        } else if (key === "level") {
          av = a.level ?? -Infinity;
          bv = b.level ?? -Infinity;
        } else {
          av = (a[key] || "").toString().toLowerCase();
          bv = (b[key] || "").toString().toLowerCase();
        }
        if(av < bv) return -1*sortDir;
        if(av > bv) return 1*sortDir;
        return 0;
      });
      renderTable();
      // Mise √† jour des classes d'ent√™te pour fl√®ches
      document.querySelectorAll("th").forEach((th,i) => {
        th.classList.remove("sorted-asc","sorted-desc");
        if(i===sortCol) th.classList.add(sortDir===1 ? "sorted-asc":"sorted-desc");
      });
    }
  </script>
</body>
</html>
